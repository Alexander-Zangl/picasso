#!/usr/bin/env python
"""
    picasso.__main__
    ~~~~~~~~~~~~~~~~

    Picasso command line interface

    :author: Joerg Schnitzbauer, 2015
"""


import glob
import os.path
import yaml
from . import io, localize, postprocess


def _localize(files, parameters_file, verbose=True):
    paths = glob.glob(files)
    n_files = len(paths)
    if n_files:
        with open(parameters_file, 'r') as parameters_file:
            parameters = yaml.load(parameters_file)
        for i, path in enumerate(paths):
            if verbose:
                print('Localizing in file {}/{}...'.format(i + 1, n_files), end='\r')
            movie, info = io.load_raw(path)
            locs = localize.localize(movie, info, parameters)
            base, ext = os.path.splitext(path)
            info = [info, parameters.update({'Generated by': 'Picasso Localize'})]
            io.save_locs(base + '_locs.hdf5', locs, info)
    else:
        if verbose:
            print('No files matching {}'.format(files))
    return n_files


def _link(files, radius, tolerance):
    paths = glob.glob(files)
    for path in paths:
        locs, info = io.load_locs(path)
        linked_locs = postprocess.link(locs, radius, tolerance)
        base, ext = os.path.splitext(path)
        link_info = {'Radius': radius,
                     'Maximum Transient Dark Time': tolerance,
                     'Generated by': 'Picasso Link'}
        info.append(link_info)
        io.save_locs(base + '_linked.hdf5', linked_locs, info)


if __name__ == '__main__':
    import argparse

    # Main parser
    parser = argparse.ArgumentParser('picasso')
    subparsers = parser.add_subparsers(dest='command')

    # toraw parser
    toraw_parser = subparsers.add_parser('toraw', help='convert image sequences to binary raw files and accompanied YAML information files')
    toraw_parser.add_argument('files', help='one or multiple files specified by a unix style pathname pattern')

    # localize parser
    localize_parser = subparsers.add_parser('localize', help='identify and localize fluorescent single molecules in an image sequence')
    localize_parser.add_argument('files', help='one or multiple raw files specified by a unix style path pattern')
    localize_parser.add_argument('parameters', help='a yaml parameter file')

    # link parser
    link_parser = subparsers.add_parser('link', help='link localizations in consecutive frames')
    link_parser.add_argument('files', help='one or multiple hdf5 localization files specified by a unix style path pattern')
    link_parser.add_argument('-r', '--radius', type=float,
                             help='maximum distance between consecutive localization to still consider them the same binding event')
    link_parser.add_argument('-t', '--tolerance', type=int,
                             help='maximum dark time between localizations to still consider them the same binding event')

    # Parse
    args = parser.parse_args()
    if args.command:
        if args.command == 'toraw':
            io.to_raw(args.files, verbose=True)
        elif args.command == 'localize':
            _localize(args.files, args.parameters, verbose=True)
        elif args.command == 'link':
            _link(args.files, args.radius, args.tolerance)
    else:
        parser.print_help()
